<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <link rel="icon" type="image/png" href="logo/logo-png.png">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>تقی پور نشر — نسخه بهبود‌یافته</title>
<style>
:root {
  --bg: #f5f7fb;
  --card: #fff;
  --text: #111827;
  --muted: #6b7280;
  --primary: #3b82f6;
  --accent: #ff7e30;
  --success: #16a34a;
  --danger: #ef4444;
  --radius: 12px;
  --shadow: 0 6px 18px rgba(2,6,23,.08);
}

[data-theme="dark"] {
  --bg: #0b1320;
  --card: #0f1724;
  --text: #e6eef8;
  --muted: #9aa6bd;
}

* { box-sizing: border-box; }
html, body { height: 100%; }
body {
  margin: 0; font-family: Vazirmatn, system-ui, -apple-system, 'Segoe UI', Roboto, "Helvetica Neue", Arial, sans-serif;
  color: var(--text); background: var(--bg); transition: background .25s, color .25s; line-height: 1.5;
}
.container { max-width: 1100px; margin: 0 auto; padding: 16px; }

/* HEADER */
header { display: flex; flex-wrap: wrap; align-items: center; justify-content: space-between; gap: 12px; padding: 12px 16px; border-radius: var(--radius); background: linear-gradient(90deg, var(--primary), #6ea8ff); color: #fff; }
.brand { display: flex; gap: 12px; align-items: center; }
.logo { width: 44px; height: 44px; border-radius: 50%; background: #fff; color: var(--primary); display: grid; place-items: center; font-weight: 700; flex-shrink: 0; }
nav { display: flex; flex-wrap: wrap; gap: 6px; }
nav a { color: inherit; padding: 8px 12px; border-radius: 9px; background: rgba(255, 255, 255, .08); text-decoration: none; font-size: 14px; white-space: nowrap; }
nav a.active { background: var(--accent); color: #111; }
.toolbar { display: flex; gap: 8px; align-items: center; }

/* BUTTONS */
.btn { background: var(--primary); color: #fff; padding: 8px 14px; border-radius: 10px; border: 0; cursor: pointer; font-size: 14px; transition: background .2s; }
.btn:hover { background: #2563eb; }
.btn.ghost { background: transparent; border: 1px solid rgba(255,255,255,.2); color: #fff; }
.btn.secondary { background: #6b7280; }
.btn.wide { width: 100%; }

/* LAYOUT */
main { display: grid; grid-template-columns: 1fr; gap: 16px; margin-top: 18px; }
aside, section { background: var(--card); border-radius: var(--radius); padding: 14px; box-shadow: var(--shadow); }

/* USER CARD */
.user-card { text-align: center; }
.avatar { width: 80px; height: 80px; border-radius: 50%; object-fit: cover; border: 3px solid #e6eef8; }
.muted { color: var(--muted); font-size: 13px; }

/* COMPOSER */
.composer textarea { width: 100%; min-height: 90px; padding: 10px; border-radius: 12px; border: 1px solid rgba(0,0,0,.08); resize: vertical; font-family: inherit; }
.composer .row { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
.preview { display: none; margin-top: 8px; }
.preview img, .preview video { max-width: 100%; border-radius: 10px; border: 1px solid rgba(0,0,0,.08); }

/* FEED */
.tweet { border-radius: 12px; padding: 12px; margin: 10px 0; border: 1px solid rgba(0,0,0,.04); background: linear-gradient(180deg, rgba(255,255,255,.02), transparent); }
.tweet .meta { font-size: 12px; color: var(--muted); }
.actions { display: flex; gap: 8px; align-items: center; margin-top: 8px; }
.like-btn, .dislike-btn, .del-btn { background: transparent; border: 1px solid rgba(0,0,0,.06); padding: 6px 8px; border-radius: 8px; cursor: pointer; }
.like-btn.liked { background: var(--danger); color: #fff; border-color: var(--danger); }
.dislike-btn.disliked { background: #999; color: #fff; border-color: #999; }
.comments { margin-top: 8px; font-size: 13px; }
.comments .add-comment { display: flex; gap: 4px; margin-top:4px; }
.comments input { flex:1; padding:4px 6px; border-radius:6px; border:1px solid rgba(0,0,0,.1); }

/* CONTROLS */
.controls { display: flex; gap: 8px; flex-wrap: wrap; }
.filters input[type="text"] { padding: 8px; border-radius: 8px; border: 1px solid rgba(0,0,0,.06); }

/* FOOTER */
.footer { margin-top: 18px; text-align: center; color: var(--muted); font-size: 14px; }

/* TOAST */
.toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: var(--primary); color: #fff; padding: 12px 20px; border-radius: 12px; opacity: 0; transition: opacity .3s; z-index: 1000; }

/* PAGES */
.page { display: none; }
.page.active { display: block; }

/* RESPONSIVE */
@media (min-width: 901px) { main { grid-template-columns: 280px 1fr; } }
@media (max-width: 600px) {
  header { flex-direction: column; align-items: flex-start; }
  nav { width: 100%; justify-content: flex-start; overflow-x: auto; scrollbar-width: none; }
  nav::-webkit-scrollbar { display: none; }
  .toolbar { width: 100%; justify-content: flex-start; flex-wrap: wrap; }
  .btn { flex: 1; text-align: center; }
}
</style>
<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
</head>
<body data-theme="light">
<header class="container">
  <div class="brand">
    <div class="logo">TP</div>
    <div>
      <div style="font-weight:700" data-i18n="appName">تقی پور نشر</div>
      <div class="muted" style="font-size:13px" data-i18n="appSubtitle">پلتفرم اشتراک گذاری افکار</div>
    </div>
  </div>
  <nav id="tabs">
    <a href="#home" data-page="home" class="active" data-i18n="home">خانه</a>
    <a href="#rules" data-page="rules" data-i18n="rules">قوانین</a>
    <a href="#settings" data-page="settings" data-i18n="settings">تنظیمات</a>
    <a href="#contact" data-page="contact" data-i18n="contact">ارتباط با ما</a>
  </nav>
  <div class="toolbar">
    <button id="language-toggle" class="btn ghost" data-i18n="language">English</button>
    <button id="theme-toggle" class="btn ghost" data-i18n="darkMode">حالت شب</button>
    <button id="login-open" class="btn" data-i18n="loginSignup">ورود / ثبت</button>
    <button id="logout" class="btn" style="display:none;background:var(--danger)" data-i18n="logout">خروج</button>
  </div>
</header>

<div class="container">
  <main>
    <aside>
      <div class="user-card">
        <img id="avatar" class="avatar" src="https://ui-avatars.com/api/?name=Guest&background=6e9cd2&color=fff" alt="avatar">
        <h3 id="displayName" data-i18n="guest">مهمان</h3>
        <div id="userEmail" class="muted" data-i18n="loginToPost">برای ارسال پیام وارد شوید</div>
      </div>

      <div style="height:12px"></div>

      <div class="card">
        <strong data-i18n="filters">فیلترها</strong>
        <div style="height:8px"></div>
        <div class="filters">
          <input id="search" type="text" placeholder="جستجو در متن پیام..." data-i18n-placeholder="searchPlaceholder">
          <div style="height:8px"></div>
          <label><input id="mine" type="checkbox" data-i18n="onlyMyPosts"> فقط پیام‌های من</label><br>
          <label><input id="likedOnly" type="checkbox" data-i18n="onlyLiked"> فقط لایک‌شده‌ها</label>
          <div style="height:8px"></div>
          <select id="sort">
            <option value="new" data-i18n="newest">جدیدترین</option>
            <option value="old" data-i18n="oldest">قدیمی‌ترین</option>
            <option value="popular" data-i18n="mostPopular">محبوب‌ترین</option>
          </select>
          <div style="height:8px"></div>
          <button id="applyFilters" class="btn" data-i18n="applyFilters">اعمال فیلتر</button>
        </div>
      </div>

      <div style="height:12px"></div>

      <div class="card">
        <strong data-i18n="contactUs">ارتباط با ما</strong>
        <div style="margin-top:8px">
          <a href="https://www.instagram.com/parhammmm322/" target="_blank" data-i18n="instagram">اینستاگرام: @parhammmm322</a><br>
          <a href="https://t.me/mmdparham91" target="_blank" data-i18n="telegram">تلگرام: mmdparham91</a>
        </div>
      </div>
    </aside>

    <section>
      <!-- PAGES WRAPPER -->
      <div id="page-home" class="page active">
        <div id="composer" class="composer" style="display:none">
          <div class="card">
            <h3 data-i18n="newPost">نوشتن پیام جدید</h3>
            <textarea id="text" placeholder="چی در ذهنت هست؟" data-i18n-placeholder="whatsOnMind"></textarea>
            <div id="charCounter" class="muted" style="margin-top:6px; font-size:12px; display:none"></div>
            <div class="row" style="margin-top:8px">
              <input id="media" type="file" accept="image/*,video/*">
              <button id="clearMedia" class="btn secondary" data-i18n="clearFile">حذف فایل</button>
              <span class="muted" id="uploadHint" data-i18n="optionalMedia">(اختیاری: عکس/ویدیو)</span>
              <div class="muted" style="margin-inline-start:auto" data-i18n="totalPosts">کل پیام‌ها: <span id="count">0</span></div>
            </div>
            <div class="preview" id="preview"></div>
            <div id="uploadProgressWrap" style="display:none;margin-top:8px">
              <div style="height:8px;background:#e5e7eb;border-radius:8px;overflow:hidden">
                <div id="uploadBar" style="height:8px;width:0%;background:var(--primary)"></div>
              </div>
              <div class="muted" id="uploadPct" style="font-size:12px;margin-top:4px">0%</div>
            </div>
            <div style="height:8px"></div>
            <div class="controls">
              <button id="post" class="btn" data-i18n="send">ارسال</button>
              <button id="saveDraft" class="btn secondary" style="display:none" data-i18n="saveDraft">ذخیره پیش‌نویس</button>
              <button id="clearDraft" class="btn secondary" style="display:none" data-i18n="clearDraft">حذف پیش‌نویس</button>
            </div>
          </div>
        </div>

        <div id="feedToolbar" style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin:8px 0">
          <!-- Will be filled by enhancements -->
        </div>

        <div id="feeds"></div>
        <div id="empty" style="display:none;text-align:center;padding:18px;color:var(--muted)" data-i18n="noPostsFound">هیچ پیامی یافت نشد</div>

        <div id="pager" style="display:none;text-align:center;margin-top:12px">
          <button id="loadMore" class="btn" data-i18n="loadMore">بیشتر</button>
        </div>
      </div>

      <div id="page-rules" class="page">
        <h3 data-i18n="rules">قوانین</h3>
        <ul>
          <li data-i18n="rule1">رعایت احترام به تمام کاربران.</li>
          <li data-i18n="rule2">محتوای غیرقانونی یا ناقض کپی‌رایت ممنوع.</li>
          <li data-i18n="rule3">هر کاربر مسئول محتوای منتشرشده‌ی خود است.</li>
          <li data-i18n="rule4">تصاویر و ویدیوهای نامناسب حذف خواهند شد.</li>
        </ul>
      </div>

      <div id="page-settings" class="page">
        <h3 data-i18n="settings">تنظیمات</h3>
        <label><input type="checkbox" id="persistTheme" data-i18n="persistTheme"> ذخیره حالت شب/روز</label>
        <div style="height:12px"></div>
        <label><input type="checkbox" id="persistLanguage" data-i18n="persistLanguage"> ذخیره زبان انتخابی</label>
      </div>

      <div id="page-contact" class="page">
        <h3 data-i18n="contactUs">ارتباط با ما</h3>
        <p data-i18n="contactDescription">برای پیشنهادات و گزارش خطاها از طریق اینستاگرام یا تلگرام در باکس کنار پیام دهید.</p>
      </div>
    </section>
  </main>

  <div class="footer">© <span id="year"></span> <span data-i18n="appName">تقی پور نشر</span> - <span data-i18n="allRightsReserved">تمام حقوق محفوظ است</span></div>
</div>

<!-- Login Modal -->
<div id="loginModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:999">
  <div style="max-width:420px;margin:8% auto;background:var(--card);padding:16px;border-radius:12px;">
    <h3 data-i18n="loginSignup">ورود / ثبت نام</h3>
    <input id="in-email" type="email" placeholder="ایمیل" data-i18n-placeholder="email" style="width:100%;margin:6px 0;padding:10px;border-radius:10px;border:1px solid rgba(0,0,0,.1)"><br>
    <input id="in-pass" type="password" placeholder="رمز عبور" data-i18n-placeholder="password" style="width:100%;margin:6px 0;padding:10px;border-radius:10px;border:1px solid rgba(0,0,0,.1)"><br>
    <div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap">
      <button id="emailLogin" class="btn" data-i18n="loginSignup">ورود / ثبت نام</button>
      <button id="googleLogin" class="btn" style="background:#ea4335" data-i18n="loginWithGoogle">ورود با گوگل</button>
      <button id="closeLogin" class="btn ghost" data-i18n="cancel">انصراف</button>
    </div>
  </div>
</div>

<div id="toast" class="toast"></div>

<script>
// ================= Firebase Init =================
const firebaseConfig = {
  apiKey: "AIzaSyDbIq00yvB2xJTtqmoUo-xFj10hYEYl9Ac",
  authDomain: "parsnashr-eb1f3.firebaseapp.com",
  projectId: "parsnashr-eb1f3",
  storageBucket: "parsnashr-eb1f3.appspot.com",
  messagingSenderId: "875762126889",
  appId: "1:875762126889:web:1f32d90eca2c221ca84c38",
  measurementId: "G-33SLCFGP3N"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
const storage = firebase.storage();

// ================ Helpers ================
const $ = q => document.querySelector(q);
const $$ = q => document.querySelectorAll(q);
const byId = id => document.getElementById(id);

function toast(msg, success=true){
  const t = byId('toast');
  t.textContent = msg; t.style.background = success ? 'var(--success)' : 'var(--danger)';
  t.style.opacity = 1; setTimeout(()=>t.style.opacity=0,2500);
}

// ================ Language Support ================
const translations = {
  fa: {
    appName: "تقی پور نشر",
    appSubtitle: "پلتفرم اشتراک گذاری افکار",
    home: "خانه",
    rules: "قوانین",
    settings: "تنظیمات",
    contact: "ارتباط با ما",
    darkMode: "حالت شب",
    loginSignup: "ورود / ثبت",
    logout: "خروج",
    guest: "مهمان",
    loginToPost: "برای ارسال پیام وارد شوید",
    filters: "فیلترها",
    searchPlaceholder: "جستجو در متن پیام...",
    onlyMyPosts: "فقط پیام‌های من",
    onlyLiked: "فقط لایک‌شده‌ها",
    newest: "جدیدترین",
    oldest: "قدیمی‌ترین",
    mostPopular: "محبوب‌ترین",
    applyFilters: "اعمال فیلتر",
    contactUs: "ارتباط با ما",
    instagram: "اینستاگرام: @parhammmm322",
    telegram: "تلگرام: mmdparham91",
    newPost: "نوشتن پیام جدید",
    whatsOnMind: "چی در ذهنت هست؟",
    clearFile: "حذف فایل",
    optionalMedia: "(اختیاری: عکس/ویدیو)",
    totalPosts: "کل پیام‌ها:",
    send: "ارسال",
    noPostsFound: "هیچ پیامی یافت نشد",
    rule1: "رعایت احترام به تمام کاربران.",
    rule2: "محتوای غیرقانونی یا ناقض کپی‌رایت ممنوع.",
    rule3: "هر کاربر مسئول محتوای منتشرشده‌ی خود است.",
    rule4: "تصاویر و ویدیوهای نامناسب حذف خواهند شد.",
    persistTheme: "ذخیره حالت شب/روز",
    persistLanguage: "ذخیره زبان انتخابی",
    contactDescription: "برای پیشنهادات و گزارش خطاها از طریق اینستاگرام یا تلگرام در باکس کنار پیام دهید.",
    allRightsReserved: "تمام حقوق محفوظ است",
    email: "ایمیل",
    password: "رمز عبور",
    loginWithGoogle: "ورود با گوگل",
    cancel: "انصراف",
    language: "English",
    deleteConfirm: "حذف شود؟",
    deleteSuccess: "حذف شد",
    postSuccess: "پیام ارسال شد",
    loginRequired: "برای ارسال باید وارد شوید",
    enterTextOrMedia: "متن یا مدیا را وارد کنید",
    enterEmailPass: "ایمیل و رمز را وارد کنید",
    loginSuccess: "ورود موفق",
    signupSuccess: "ثبت نام موفق",
    googleLoginSuccess: "ورود با گوگل موفق بود",
    likeRequired: "برای لایک باید وارد شوید",
    dislikeRequired: "برای دیسلایک باید وارد شوید"
  },
  en: {
    appName: "taghipour Nashr",
    appSubtitle: "Thought Sharing Platform",
    home: "Home",
    rules: "Rules",
    settings: "Settings",
    contact: "Contact Us",
    darkMode: "Dark Mode",
    loginSignup: "Login / Signup",
    logout: "Logout",
    guest: "Guest",
    loginToPost: "Login to post messages",
    filters: "Filters",
    searchPlaceholder: "Search in messages...",
    onlyMyPosts: "Only my posts",
    onlyLiked: "Only liked posts",
    newest: "Newest",
    oldest: "Oldest",
    mostPopular: "Most Popular",
    applyFilters: "Apply Filters",
    contactUs: "Contact Us",
    instagram: "Instagram: @parhammmm322",
    telegram: "Telegram: mmdparham91",
    newPost: "Write New Post",
    whatsOnMind: "What's on your mind?",
    clearFile: "Clear File",
    optionalMedia: "(Optional: image/video)",
    totalPosts: "Total posts there is:",
    send: "Send",
    noPostsFound: "No posts found",
    rule1: "Respect all users.",
    rule2: "Illegal content or copyright infringement is prohibited.",
    rule3: "Each user is responsible for their published content.",
    rule4: "Inappropriate images and videos will be removed.",
    persistTheme: "Save day/night mode",
    persistLanguage: "Save language preference",
    contactDescription: "For suggestions and bug reports, contact us via Instagram or Telegram in the side box.",
    allRightsReserved: "All rights reserved",
    email: "Email",
    password: "Password",
    loginWithGoogle: "Login with Google",
    cancel: "Cancel",
    language: "فارسی",
    deleteConfirm: "Delete?",
    deleteSuccess: "Deleted",
    postSuccess: "Post sent successfully",
    loginRequired: "You need to login to post",
    enterTextOrMedia: "Enter text or media",
    enterEmailPass: "Enter email and password",
    loginSuccess: "Login successful",
    signupSuccess: "Signup successful",
    googleLoginSuccess: "Google login successful",
    likeRequired: "You need to login to like",
    dislikeRequired: "You need to login to dislike a post"
  }
};

let currentLanguage = 'fa';

function changeLanguage(lang) {
  currentLanguage = lang;
  
  // Update HTML lang and dir attributes
  document.documentElement.lang = lang;
  document.documentElement.dir = lang === 'fa' ? 'rtl' : 'ltr';
  
  // Update all elements with data-i18n attribute
  document.querySelectorAll('[data-i18n]').forEach(el => {
    const key = el.getAttribute('data-i18n');
    if (translations[lang][key]) {
      el.textContent = translations[lang][key];
    }
  });
  
  // Update all placeholder elements
  document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
    const key = el.getAttribute('data-i18n-placeholder');
    if (translations[lang][key]) {
      el.placeholder = translations[lang][key];
    }
  });
  
  // Update language toggle button text
  byId('language-toggle').textContent = translations[lang]['language'];
  
  // Save language preference if enabled
  if (byId('persistLanguage').checked) {
    localStorage.setItem('language', lang);
  }
}

function initLanguage() {
  const savedLanguage = localStorage.getItem('language');
  const persistLang = localStorage.getItem('persistLanguage') === 'true';
  
  byId('persistLanguage').checked = persistLang;
  
  if (savedLanguage && persistLang) {
    changeLanguage(savedLanguage);
  }
}

byId('language-toggle').onclick = () => {
  const newLang = currentLanguage === 'fa' ? 'en' : 'fa';
  changeLanguage(newLang);
};

byId('persistLanguage').onchange = (e) => {
  localStorage.setItem('persistLanguage', e.target.checked);
  if (e.target.checked) {
    localStorage.setItem('language', currentLanguage);
  } else {
    localStorage.removeItem('language');
  }
};

// ================ Theme Toggle + Persist ================
(function initTheme(){
  const saved = localStorage.getItem('theme');
  if(saved) { document.body.dataset.theme = saved; byId('theme-toggle').textContent = saved==='light'?translations[currentLanguage]['darkMode']:translations[currentLanguage]['darkMode'].replace('حالت شب', 'حالت روز'); byId('persistTheme').checked = true; }
})();
byId('theme-toggle').onclick = ()=>{
  const d = document.body; const next = d.dataset.theme==='light'?'dark':'light'; d.dataset.theme=next; byId('theme-toggle').textContent = next==='light'?translations[currentLanguage]['darkMode']:translations[currentLanguage]['darkMode'].replace('حالت شب', 'حالت روز');
  if(byId('persistTheme').checked){ localStorage.setItem('theme', next); } else { localStorage.removeItem('theme'); }
};
byId('persistTheme').onchange = (e)=>{ if(!e.target.checked){ localStorage.removeItem('theme'); } else { localStorage.setItem('theme', document.body.dataset.theme); } };

// ================ Simple Router ================
const pages = ['home','rules','settings','contact'];
function showPage(name){
  pages.forEach(p=>{
    byId('page-'+p).classList.toggle('active', p===name);
    const link = document.querySelector(`nav a[data-page="${p}"]`);
    if(link) link.classList.toggle('active', p===name);
  });
  if(name==='home'){ startFeed(); } else { stopFeed(); }
  history.replaceState(null, '', '#'+name);
}
$('#tabs').addEventListener('click', (e)=>{
  if(e.target.matches('a[data-page]')){ e.preventDefault(); showPage(e.target.dataset.page); }
});
window.addEventListener('load', ()=>{
  const initial = location.hash.replace('#','');
  showPage(pages.includes(initial)?initial:'home');
});

// ================ Login Modal & Auth ================
byId('login-open').onclick = ()=>byId('loginModal').style.display='block';
byId('closeLogin').onclick = ()=>byId('loginModal').style.display='none';

byId('emailLogin').onclick = ()=>{
  const email = byId('in-email').value.trim();
  const pass = byId('in-pass').value;
  if(!email||!pass){ toast(translations[currentLanguage]['enterEmailPass'],false); return; }
  auth.signInWithEmailAndPassword(email,pass)
    .then(()=>{byId('loginModal').style.display='none'; toast(translations[currentLanguage]['loginSuccess']);})
    .catch(err=>{
      if(err.code==='auth/user-not-found'){
        auth.createUserWithEmailAndPassword(email,pass)
          .then(()=>{byId('loginModal').style.display='none'; toast(translations[currentLanguage]['signupSuccess']);})
          .catch(e=>toast(e.message,false));
      } else toast(err.message,false);
    });
};

byId('googleLogin').onclick = async ()=>{
  try{
    const provider = new firebase.auth.GoogleAuthProvider();
    await auth.signInWithPopup(provider);
    byId('loginModal').style.display='none';
    toast(translations[currentLanguage]['googleLoginSuccess']);
  }catch(e){ toast(e.message, false); }
};

byId('logout').onclick = ()=>auth.signOut();

// ================ Auth State Listener ================
let feedUnsub = null;
function startFeed(){ if(!feedUnsub) loadTweetsRealtime(); }
function stopFeed(){ if(feedUnsub){ feedUnsub(); feedUnsub=null; } }

auth.onAuthStateChanged(user=>{
  if(user){
    byId('login-open').style.display='none';
    byId('logout').style.display='inline-block';
    byId('composer').style.display='block';
    byId('displayName').textContent = user.displayName || translations[currentLanguage]['guest'];
    byId('userEmail').textContent = user.email || '';
    byId('avatar').src=`https://ui-avatars.com/api/?name=${encodeURIComponent(user.displayName||'User')}&background=6e9cd2&color=fff`;
    startFeed();
  } else {
    byId('login-open').style.display='inline-block';
    byId('logout').style.display='none';
    byId('composer').style.display='none';
    byId('displayName').textContent=translations[currentLanguage]['guest'];
    byId('userEmail').textContent=translations[currentLanguage]['loginToPost'];
    byId('avatar').src='https://ui-avatars.com/api/?name=Guest&background=6e9cd2&color=fff';
    byId('feeds').innerHTML='';
    byId('empty').style.display='block';
    stopFeed();
  }
});

// ================ Media Handling (Preview + Upload) ================
const fileInput = byId('media');
const preview = byId('preview');
const clearBtn = byId('clearMedia');
let selectedFile = null;

fileInput.onchange = ()=>{
  const f = fileInput.files[0];
  if(!f){ preview.style.display='none'; preview.innerHTML=''; selectedFile=null; return; }
  selectedFile = f;
  const url = URL.createObjectURL(f);
  if(f.type.startsWith('image')){
    preview.innerHTML = `<img src="${url}" alt="preview">`;
  } else if(f.type.startsWith('video')){
    preview.innerHTML = `<video src="${url}" controls></video>`;
  } else {
    toast('فقط تصویر یا ویدیو مجاز است', false); fileInput.value=''; selectedFile=null; return;
  }
  preview.style.display='block';
};
clearBtn.onclick = ()=>{ fileInput.value=''; selectedFile=null; preview.style.display='none'; preview.innerHTML=''; };

async function uploadMediaIfAny(uid){
  if(!selectedFile) return null;
  const ts = Date.now();
  const ext = selectedFile.name.split('.').pop();
  const path = `media/${uid}/${ts}.${ext}`;
  const ref = storage.ref().child(path);
  await ref.put(selectedFile, { contentType: selectedFile.type });
  const url = await ref.getDownloadURL();
  return { url, type: selectedFile.type, path };
}

// ================ Post Tweet ================
byId('post').onclick = async ()=>{
  const text = byId('text').value.trim();
  if(!text && !selectedFile){ toast(translations[currentLanguage]['enterTextOrMedia'], false); return; }
  const user = auth.currentUser; if(!user){ toast(translations[currentLanguage]['loginRequired'], false); return; }

  try{
    byId('post').disabled = true; byId('post').textContent = translations[currentLanguage]['send'];
    const media = await uploadMediaIfAny(user.uid);
    const payload = {
      uid:user.uid,
      displayName:user.displayName||translations[currentLanguage]['guest'],
      email:user.email,
      text,
      likes:[],
      dislikes:[],
      comments:[],
      media: media ? { url: media.url, type: media.type, path: media.path } : null,
      created: firebase.firestore.FieldValue.serverTimestamp()
    };
    await db.collection('tweets').add(payload);
    byId('text').value=''; clearBtn.click();
    toast(translations[currentLanguage]['postSuccess']);
  }catch(e){
    toast(e.message, false);
  }finally{
    byId('post').disabled = false; byId('post').textContent = translations[currentLanguage]['send'];
  }
};

// ================ Real-time Feed + Like/Dislike/Comment =================
function renderTweets(docs){
  const user = auth.currentUser;
  const html = docs.map(d=>{
    const t = d.data(); const id = d.id; 
    const liked = user ? (t.likes||[]).includes(user.uid) : false;
    const disliked = user ? (t.dislikes||[]).includes(user.uid) : false;
    const when = t.created?.toDate ? t.created.toDate() : null;
    const dateStr = when ? when.toLocaleString(currentLanguage === 'fa' ? 'fa-IR' : 'en-US') : translations[currentLanguage]['now'];
    const mediaHTML = t.media ? (t.media.type?.startsWith('image') ? `<div style="margin-top:8px"><img src="${t.media.url}" alt="img" style="max-width:100%;border-radius:10px"></div>` : `<div style="margin-top:8px"><video src="${t.media.url}" controls style="max-width:100%;border-radius:10px"></video></div>`) : '';
    const canDelete = user && user.uid===t.uid;
    const safeText = (t.text||'').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    const commentsHTML = (t.comments||[]).map(c=>`<div>${c.user}: ${c.text}</div>`).join('');
    return `
    <div class="tweet" data-id="${id}">
      <div><strong>${t.displayName||translations[currentLanguage]['guest']}</strong> <span class="muted">${t.email||''}</span></div>
      <div>${safeText}</div>
      ${mediaHTML}
      <div class="meta">${dateStr}</div>
      <div class="actions">
        <button class="like-btn ${liked?'liked':''}" data-id="${id}">❤ ${(t.likes||[]).length}</button>
        <button class="dislike-btn ${disliked?'disliked':''}" data-id="${id}">👎 ${(t.dislikes||[]).length}</button>
        ${canDelete?`<button class="del-btn" data-del="${id}">${translations[currentLanguage]['delete']}</button>`:''}
      </div>
      <div class="comments">
        ${commentsHTML}
        ${user ? `<div class="add-comment"><input type="text" placeholder="${translations[currentLanguage]['commentPlaceholder']}"><button class="btn btn-small" data-comment="${id}">${translations[currentLanguage]['send']}</button></div>` : ''}
      </div>
    </div>`;
  }).join('');
  byId('feeds').innerHTML = html;
  byId('count').textContent = docs.length;
  byId('empty').style.display = docs.length===0 ? 'block' : 'none';

  // Like
  $$('.like-btn').forEach(b=> b.onclick = async ()=>{
    const id = b.dataset.id; const u = auth.currentUser; if(!u) return toast(translations[currentLanguage]['likeRequired'], false);
    const ref = db.collection('tweets').doc(id);
    const liked = b.classList.contains('liked');
    const op = liked ? firebase.firestore.FieldValue.arrayRemove(u.uid) : firebase.firestore.FieldValue.arrayUnion(u.uid);
    try{ await ref.update({ likes: op }); } catch(e){ toast(e.message, false); }
  });

  // Dislike
  $$('.dislike-btn').forEach(b=> b.onclick = async ()=>{
    const id = b.dataset.id; const u = auth.currentUser; if(!u) return toast(translations[currentLanguage]['dislikeRequired'], false);
    const ref = db.collection('tweets').doc(id);
    const disliked = b.classList.contains('disliked');
    const op = disliked ? firebase.firestore.FieldValue.arrayRemove(u.uid) : firebase.firestore.FieldValue.arrayUnion(u.uid);
    try{ await ref.update({ dislikes: op }); } catch(e){ toast(e.message, false); }
  });

  // Delete
  $$('[data-del]').forEach(b=> b.onclick = async ()=>{
    const id = b.getAttribute('data-del');
    if(!confirm(translations[currentLanguage]['deleteConfirm'])) return;
    try{
      const doc = await db.collection('tweets').doc(id).get();
      const t = doc.data();
      if(t.media?.path){ try{ await storage.ref().child(t.media.path).delete(); }catch(err){} }
      await doc.ref.delete();
      toast(translations[currentLanguage]['deleteSuccess']);
    }catch(e){ toast(e.message, false); }
  });

  // Comments
  $$('[data-comment]').forEach(b=> b.onclick = async ()=>{
    const id = b.dataset.comment;
    const input = b.previousElementSibling;
    const text = input.value.trim();
    if(!text) return;
    const user = auth.currentUser; if(!user) return;
    try{
      await db.collection('tweets').doc(id).update({
        comments: firebase.firestore.FieldValue.arrayUnion({ user:user.displayName||translations[currentLanguage]['guest'], text })
      });
      input.value='';
    }catch(e){ toast(e.message, false); }
  });
}

function loadTweetsRealtime(){
  feedUnsub = db.collection('tweets').orderBy('created','desc').onSnapshot(snap=>{
    renderTweets(snap.docs);
  });
}

// Initialize the app
byId('year').textContent = new Date().getFullYear();
initLanguage();
</script>

<!-- ========================= ENHANCEMENTS (ADDED FEATURES) ========================= -->
<style>
/* Added styles (do not alter existing) */
.badge { display:inline-block; padding:2px 6px; border-radius:8px; background:#eef2ff; font-size:11px; margin-inline-start:6px; }
.action-btn { background: transparent; border: 1px solid rgba(0,0,0,.06); padding:6px 8px; border-radius:8px; cursor:pointer; }
.action-row { display:flex; gap:8px; flex-wrap:wrap; margin-top:6px; }
.tweet.highlight { outline: 2px dashed var(--primary); }
.lightbox {
  position: fixed; inset: 0; display:none; place-items:center; background: rgba(0,0,0,.7); z-index: 1001;
}
.lightbox img, .lightbox video { max-width: 92vw; max-height: 86vh; border-radius: 12px; }
.kbd { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size:12px; padding:2px 6px; border-radius:6px; background:#e5e7eb; }
.bookmark { color: #f59e0b; }
.progress-inline { font-size:12px; color:var(--muted); margin-inline-start:8px; }
.feed-toggle { display:flex; gap:8px; align-items:center; }
input[type="checkbox"].switch { appearance: none; width:38px; height:22px; border-radius:20px; background:#e5e7eb; position:relative; cursor:pointer; transition:background .2s; vertical-align:middle; }
input[type="checkbox"].switch:checked { background:#93c5fd; }
input[type="checkbox"].switch::after { content:""; position:absolute; top:2px; inset-inline-start:2px; width:18px; height:18px; background:#fff; border-radius:50%; transition: inset-inline-start .2s; }
input[type="checkbox"].switch:checked::after { inset-inline-start:18px; }
.edit-area { width:100%; min-height:80px; border:1px solid rgba(0,0,0,.1); border-radius:10px; padding:8px; margin-top:8px; }
.small-muted { font-size:12px; color:var(--muted); }
</style>

<div id="lightbox" class="lightbox" role="dialog" aria-modal="true" aria-label="Media viewer">
  <div id="lightboxContent"></div>
</div>

<script>
/* =========================================================
   ADDED FEATURES — WITHOUT REMOVING OR CHANGING EXISTING CODE
   ========================================================= */

/* ---------- 0) Fill missing i18n keys & new labels ---------- */
(function enhanceI18N(){
  const add = (lang, obj) => Object.assign(translations[lang], obj);
  add('fa', {
    delete: "حذف",
    commentPlaceholder: "افزودن نظر...",
    now: "هم‌اکنون",
    edit: "ویرایش",
    save: "ذخیره",
    cancelEdit: "انصراف",
    share: "اشتراک",
    copyLink: "کپی لینک",
    copied: "کپی شد!",
    bookmark: "نشان‌کردن",
    bookmarked: "نشان شد",
    removedBookmark: "نشان حذف شد",
    report: "گزارش",
    reported: "گزارش شد",
    views: "بازدید",
    uploadProgress: "در حال آپلود...",
    saveDraft: "ذخیره پیش‌نویس",
    clearDraft: "حذف پیش‌نویس",
    draftSaved: "پیش‌نویس ذخیره شد",
    draftRestored: "پیش‌نویس بازیابی شد",
    liveMode: "حالت زنده",
    pagedMode: "صفحه‌ای",
    loadMore: "بیشتر",
    openImage: "نمایش",
    editSuccess: "ویرایش شد",
    addedToBookmarks: "به نشان‌ها افزوده شد",
    removedFromBookmarks: "از نشان‌ها حذف شد",
    linkifyHelp: "برای جستجوی هشتگ کلیک کنید",
    toggleLightbox: "برای بستن کلیک کنید"
  });
  add('en', {
    delete: "Delete",
    commentPlaceholder: "Add a comment...",
    now: "Just now",
    edit: "Edit",
    save: "Save",
    cancelEdit: "Cancel",
    share: "Share",
    copyLink: "Copy link",
    copied: "Copied!",
    bookmark: "Bookmark",
    bookmarked: "Bookmarked",
    removedBookmark: "Bookmark removed",
    report: "Report",
    reported: "Reported",
    views: "views",
    uploadProgress: "Uploading...",
    saveDraft: "Save draft",
    clearDraft: "Clear draft",
    draftSaved: "Draft saved",
    draftRestored: "Draft restored",
    liveMode: "Live mode",
    pagedMode: "Paged",
    loadMore: "Load more",
    openImage: "Open",
    editSuccess: "Edited",
    addedToBookmarks: "Added to bookmarks",
    removedFromBookmarks: "Removed from bookmarks",
    linkifyHelp: "Click to search hashtag",
    toggleLightbox: "Click anywhere to close"
  });
})();

/* ---------- 1) Character counter + draft autosave ---------- */
(function composerExtras(){
  const ta = byId('text');
  const cc = byId('charCounter');
  const saveBtn = byId('saveDraft');
  const clearBtnDraft = byId('clearDraft');
  if(!ta || !cc) return;
  const LIMIT = 500;
  cc.style.display = 'block';
  const update = ()=>{
    const len = ta.value.length;
    cc.textContent = `${len}/${LIMIT}`;
    cc.style.color = len>LIMIT ? 'var(--danger)' : 'var(--muted)';
    byId('post').disabled = len===0 && !selectedFile || len>LIMIT;
  };
  ta.addEventListener('input', update);
  update();

  const draftKey = ()=> {
    const u = auth.currentUser;
    return 'draft_' + (u ? u.uid : 'guest');
  };

  // restore draft when available
  function tryRestore(){
    const d = localStorage.getItem(draftKey());
    if(d){
      ta.value = d;
      update();
      toast(translations[currentLanguage]['draftRestored']);
    }
  }
  tryRestore();

  // show draft buttons when logged in
  auth.onAuthStateChanged(()=>{
    saveBtn.style.display = 'inline-block';
    clearBtnDraft.style.display = 'inline-block';
    tryRestore();
  });

  saveBtn.onclick = ()=>{
    localStorage.setItem(draftKey(), ta.value);
    toast(translations[currentLanguage]['draftSaved']);
  };
  clearBtnDraft.onclick = ()=>{
    localStorage.removeItem(draftKey());
    toast(translations[currentLanguage]['deleteSuccess']);
  };
})();

/* ---------- 2) Upload progress (override uploadMediaIfAny safely) ---------- */
(function overrideUpload(){
  const original = window.uploadMediaIfAny;
  window.uploadMediaIfAny = async function(uid){
    if(!selectedFile) return null;
    const ts = Date.now();
    const ext = selectedFile.name.split('.').pop();
    const path = `media/${uid}/${ts}.${ext}`;
    const ref = storage.ref().child(path);

    const wrap = byId('uploadProgressWrap');
    const bar = byId('uploadBar');
    const pct = byId('uploadPct');
    wrap.style.display = 'block'; bar.style.width = '0%'; pct.textContent='0%';

    try{
      await new Promise((resolve, reject)=>{
        const task = ref.put(selectedFile, { contentType: selectedFile.type });
        task.on('state_changed', snap=>{
          const p = Math.round((snap.bytesTransferred/snap.totalBytes)*100);
          bar.style.width = p + '%';
          pct.textContent = p + '%';
        }, reject, resolve);
      });
      const url = await ref.getDownloadURL();
      return { url, type: selectedFile.type, path };
    }catch(e){
      toast(e.message, false);
      throw e;
    }finally{
      setTimeout(()=>{ byId('uploadProgressWrap').style.display='none'; }, 500);
    }
  };
})();

/* ---------- 3) Feed modes: Live vs Paged (infinite "Load more") ---------- */
let paged = {
  enabled: false,
  lastDoc: null,
  unsub: null
};

(function feedToolbar(){
  const toolbar = byId('feedToolbar');
  if(!toolbar) return;
  toolbar.innerHTML = `
    <div class="feed-toggle">
      <label style="display:flex;align-items:center;gap:6px">
        <input id="toggleLive" type="checkbox" class="switch" checked>
        <span class="muted">${translations[currentLanguage]['liveMode']}</span>
      </label>
      <button id="refreshFeed" class="btn secondary">⟳</button>
      <span class="small-muted">Tip: <span class="kbd">Ctrl</span>+<span class="kbd">Enter</span> = ${translations[currentLanguage]['send']}</span>
    </div>
  `;
  const toggle = byId('toggleLive');
  const pagerWrap = byId('pager');
  toggle.addEventListener('change', ()=>{
    const live = toggle.checked;
    if(live){
      paged.enabled = false;
      pagerWrap.style.display = 'none';
      startFeed(); // uses existing
      toast(translations[currentLanguage]['liveMode']);
    }else{
      stopFeed();
      paged.enabled = true;
      byId('feeds').innerHTML = '';
      paged.lastDoc = null;
      pagerWrap.style.display = 'block';
      loadPage();
      toast(translations[currentLanguage]['pagedMode']);
    }
  });
  byId('refreshFeed').onclick = ()=>{
    if(toggle.checked){ // live
      stopFeed(); startFeed();
    } else {
      byId('feeds').innerHTML = ''; paged.lastDoc=null; loadPage();
    }
  };
  byId('loadMore').onclick = ()=> loadPage();
})();

async function loadPage(limit=10){
  let q = db.collection('tweets').orderBy('created','desc').limit(limit);
  if(paged.lastDoc) q = q.startAfter(paged.lastDoc);
  const snap = await q.get();
  const docs = snap.docs;
  paged.lastDoc = docs.length ? docs[docs.length-1] : paged.lastDoc;
  appendTweets(docs);
}

function appendTweets(docs){
  const container = byId('feeds');
  const prevHTML = container.innerHTML;
  renderTweets(docs); // renders only new docs, so we need to append, not replace
  const newHTML = container.innerHTML;
  container.innerHTML = prevHTML + newHTML;
  // re-bind enhancements after new content appended
  afterRenderEnhancements();
}

/* ---------- 4) After-render enhancements (edit/share/bookmark/report/views/lightbox/linkify) ---------- */
function afterRenderEnhancements(){
  // 4.1 Add extra action row to each tweet
  $$('.tweet').forEach(t=>{
    if(t.querySelector('.action-row')) return; // already enhanced
    const id = t.getAttribute('data-id');
    const isOwner = !!t.querySelector('[data-del]');
    const row = document.createElement('div');
    row.className = 'action-row';
    row.innerHTML = `
      ${isOwner ? `<button class="action-btn btn-edit">${translations[currentLanguage]['edit']}</button>` : ''}
      <button class="action-btn btn-share">🔗 ${translations[currentLanguage]['share']}</button>
      <button class="action-btn btn-bookmark">⭐ ${translations[currentLanguage]['bookmark']}</button>
      <button class="action-btn btn-report">🚩 ${translations[currentLanguage]['report']}</button>
      <span class="small-muted vcount" title="${translations[currentLanguage]['views']}">0 ${translations[currentLanguage]['views']}</span>
    `;
    t.querySelector('.actions').after(row);

    // 4.2 Views counter (session de-dup)
    const seenKey = 'viewed_' + id;
    if(!sessionStorage.getItem(seenKey)){
      sessionStorage.setItem(seenKey, '1');
      db.collection('tweets').doc(id).update({ views: firebase.firestore.FieldValue.increment(1) }).catch(()=>{});
    }
    // Show current views
    db.collection('tweets').doc(id).get().then(d=>{
      const v = d.data()?.views || 0;
      const vEl = t.querySelector('.vcount');
      if(vEl) vEl.textContent = `${v} ${translations[currentLanguage]['views']}`;
    });

    // 4.3 Edit inline
    const editBtn = t.querySelector('.btn-edit');
    if(editBtn){
      editBtn.onclick = ()=>{
        const textDiv = t.children[1];
        const original = textDiv.textContent;
        const editBox = document.createElement('textarea');
        editBox.className = 'edit-area';
        editBox.value = original;
        const save = document.createElement('button'); save.className='btn'; save.textContent = translations[currentLanguage]['save'];
        const cancel = document.createElement('button'); cancel.className='btn secondary'; cancel.textContent = translations[currentLanguage]['cancelEdit'];
        const wrap = document.createElement('div'); wrap.style.marginTop='8px';
        wrap.appendChild(editBox); wrap.appendChild(document.createElement('div')).style.height='6px';
        wrap.appendChild(save); wrap.appendChild(document.createTextNode(' ')); wrap.appendChild(cancel);
        textDiv.after(wrap);
        editBtn.disabled = true;

        save.onclick = async ()=>{
          const newText = editBox.value.trim();
          try{
            await db.collection('tweets').doc(id).update({ text: newText, editedAt: firebase.firestore.FieldValue.serverTimestamp() });
            textDiv.textContent = newText;
            wrap.remove();
            editBtn.disabled = false;
            toast(translations[currentLanguage]['editSuccess']);
            // re-linkify after edit
            linkifyElement(textDiv);
          }catch(e){ toast(e.message, false); }
        };
        cancel.onclick = ()=>{ wrap.remove(); editBtn.disabled=false; };
      };
    }

    // 4.4 Share/copy link
    t.querySelector('.btn-share').onclick = async ()=>{
      const url = location.origin + location.pathname + `?post=${id}#home`;
      if(navigator.share){
        try{ await navigator.share({ title: 'Post', url }); }catch(_){}
      } else {
        try{ await navigator.clipboard.writeText(url); toast(translations[currentLanguage]['copied']); }catch(_){}
      }
    };

    // 4.5 Bookmark
    t.querySelector('.btn-bookmark').onclick = async ()=>{
      const u = auth.currentUser; if(!u) return toast(translations[currentLanguage]['loginRequired'], false);
      const ref = db.collection('users').doc(u.uid).collection('bookmarks').doc(id);
      const snap = await ref.get();
      if(snap.exists){
        await ref.delete();
        toast(translations[currentLanguage]['removedFromBookmarks']);
      }else{
        await ref.set({ added: firebase.firestore.FieldValue.serverTimestamp() });
        toast(translations[currentLanguage]['addedToBookmarks']);
      }
    };

    // 4.6 Report
    t.querySelector('.btn-report').onclick = async ()=>{
      const u = auth.currentUser; if(!u) return toast(translations[currentLanguage]['loginRequired'], false);
      await db.collection('reports').add({ postId:id, by:u.uid, created: firebase.firestore.FieldValue.serverTimestamp() });
      toast(translations[currentLanguage]['reported']);
    };

    // 4.7 Lightbox for media
    t.querySelectorAll('img, video').forEach(m=>{
      m.style.cursor='zoom-in';
      m.title = translations[currentLanguage]['openImage'];
      m.addEventListener('click', ()=> openLightbox(m.tagName.toLowerCase(), m.src));
    });

    // 4.8 Linkify hashtags and URLs in the text block
    linkifyElement(t.children[1]);
  });

  // highlight if deep-linking to a post
  const params = new URLSearchParams(location.search);
  const pid = params.get('post');
  if(pid){
    const target = document.querySelector(`.tweet[data-id="${pid}"]`);
    if(target){
      target.classList.add('highlight');
      target.scrollIntoView({behavior:'smooth', block:'center'});
      setTimeout(()=>target.classList.remove('highlight'), 2500);
    }
  }
}
function linkifyElement(el){
  if(!el) return;
  const esc = el.textContent || '';
  const withLinks = esc
    .replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank" rel="noopener">$1</a>')
    .replace(/#([\u0600-\u06FF\w]+)/g, (m,tag)=> `<a href="#home" title="${translations[currentLanguage]['linkifyHelp']}" onclick="filterByHashtag('${tag}')">#${tag}</a>`);
  el.innerHTML = withLinks;
}
window.filterByHashtag = function(tag){
  byId('search').value = '#'+tag;
  byId('applyFilters').click();
};

/* ---------- 5) Lightbox implementation ---------- */
function openLightbox(kind, src){
  const lb = byId('lightbox');
  const box = byId('lightboxContent');
  box.innerHTML = kind==='img' ? `<img src="${src}" alt="">` : `<video src="${src}" controls autoplay></video>`;
  lb.style.display='grid';
  lb.title = translations[currentLanguage]['toggleLightbox'];
}
byId('lightbox').addEventListener('click', ()=> byId('lightbox').style.display='none');

/* ---------- 6) Keyboard shortcuts ---------- */
(function shortcuts(){
  document.addEventListener('keydown', (e)=>{
    // Ctrl/Cmd + Enter to send
    if((e.ctrlKey || e.metaKey) && e.key==='Enter'){
      if(document.activeElement === byId('text') || byId('text').value.trim().length){
        byId('post').click();
      }
    }
    // "n" focuses composer
    if(e.key==='n' && !['INPUT','TEXTAREA'].includes(document.activeElement.tagName)){
      const ta = byId('text'); if(ta){ ta.focus(); }
    }
  });
})();

/* ---------- 7) Apply filters locally (client-side search/like/mine/popular) ---------- */
(function filtersEnhance(){
  byId('applyFilters').addEventListener('click', ()=>{
    const q = byId('search').value.toLowerCase().trim();
    const onlyMine = byId('mine').checked;
    const likedOnly = byId('likedOnly').checked;
    const sort = byId('sort').value;

    const user = auth.currentUser;
    const items = Array.from($$('.tweet'));
    items.forEach(t=>{
      const id = t.getAttribute('data-id');
      const text = (t.children[1]?.innerText || '').toLowerCase();
      const owner = !!t.querySelector('[data-del]');
      const liked = t.querySelector('.like-btn')?.classList.contains('liked');
      let ok = true;
      if(q){
        ok = text.includes(q) || (q.startsWith('#') && text.includes(q));
      }
      if(onlyMine && !owner) ok = false;
      if(likedOnly && !liked) ok = false;
      t.style.display = ok ? '' : 'none';
    });

    // sorting by DOM re-order
    const container = byId('feeds');
    const visible = items.filter(el=> el.style.display!=='none');
    visible.sort((a,b)=>{
      if(sort==='old'){ return 1; } // keep original older after (since rendered desc)
      if(sort==='popular'){
        const la = parseInt(a.querySelector('.like-btn')?.textContent.replace(/[^\d]/g,'')||'0',10);
        const lb = parseInt(b.querySelector('.like-btn')?.textContent.replace(/[^\d]/g,'')||'0',10);
        return lb - la;
      }
      return -1; // newest (already)
    });
    visible.forEach(el=> container.appendChild(el));
    byId('empty').style.display = visible.length ? 'none' : 'block';
  });
})();

/* ---------- 8) Enhance start/stop to re-run enhancements after renders ---------- */
(function hookRenders(){
  const originalRender = window.renderTweets;
  window.renderTweets = function(docs){
    originalRender(docs);
    afterRenderEnhancements();
  };
})();

/* ---------- 9) PWA (manifest + service worker registration) ---------- */
(function setupPWA(){
  // Create a simple manifest dynamically (no edits to <head>)
  const manifest = {
    name: "Taghipour Nashr",
    short_name: "TP Nashr",
    start_url: ".",
    display: "standalone",
    background_color: "#0f172a",
    theme_color: "#3b82f6",
    icons: []
  };
  const blob = new Blob([JSON.stringify(manifest)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const link = document.createElement('link');
  link.rel = 'manifest'; link.href = url;
  document.head.appendChild(link);

  // Register SW
  const swCode = `
    const CACHE = 'tpnashr-v1';
    const ASSETS = [
      './',
      location.href
    ];
    self.addEventListener('install', e=>{
      e.waitUntil(caches.open(CACHE).then(c=>c.addAll(ASSETS)).then(()=>self.skipWaiting()));
    });
    self.addEventListener('activate', e=> e.waitUntil(self.clients.claim()));
    self.addEventListener('fetch', e=>{
      const req = e.request;
      if(req.method!=='GET') return;
      e.respondWith(
        caches.match(req).then(cached=>{
          const fetchPromise = fetch(req).then(res=>{
            const copy = res.clone();
            caches.open(CACHE).then(c=>c.put(req, copy));
            return res;
          }).catch(()=> cached);
          return cached || fetchPromise;
        })
      );
    });
  `;
  const swBlob = new Blob([swCode], {type:'text/javascript'});
  const swUrl = URL.createObjectURL(swBlob);
  if('serviceWorker' in navigator){
    navigator.serviceWorker.register(swUrl).catch(()=>{});
  }
})();

/* ---------- 10) Small accessibility & UX touches ---------- */
(function a11y(){
  // Focus outline helper
  document.addEventListener('keydown', e=>{
    if(e.key==='Tab'){ document.body.classList.add('keyboard'); }
  });
  document.addEventListener('mousedown', ()=> document.body.classList.remove('keyboard'));
  // Set aria-live for toast
  const t = byId('toast'); t.setAttribute('role','status'); t.setAttribute('aria-live','polite');
})();

</script>
</body>
</html>
